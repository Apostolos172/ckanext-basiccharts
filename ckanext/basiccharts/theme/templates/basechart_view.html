{% resource 'basiccharts/main' %}

{% block scripts %}
<script>
  window.onload = function() {
    var endpoint = "http://localhost:5000/api",
        chartType = "{{ chart_type }}",
        resourceView = {{ h.dump_json(resource_view) | safe }},
        params = setupParams(resourceView, chartType),
        resource = {{ h.dump_json(resource) | safe }};
    resource.endpoint = endpoint;

    function sortData(data) {
      var result = data,
          seriesOrder = params.filters[params.series],
          xAxisOrder = params.filters[params.x_axis];

      // Order legends
      if (seriesOrder) {
        result.sort(function (a, b) {
          return seriesOrder.indexOf(a.label) - seriesOrder.indexOf(b.label);
        });
      }

      // Order x axis, if it exists
      if (params.x_axis && xAxisOrder) {
        $.each(result, function (i, element) {
          element.data.sort(function (a, b) {
            return xAxisOrder.indexOf(a[0]) - xAxisOrder.indexOf(b[0]);
          });
        });
      }

      return result;
    }

    // FIXME: We'll have problems with multiple elements on the same page.
    // Right now, they'll have the same ID.
    ckan.views.basiccharts.init("#graph", resource, params, sortData);
  }

function setupParams(defaultParams, chartType) {
  var routeParams = window.location.search.queryStringToJSON(),
      params = {
        chart_type: chartType,
        filters: setupFilters(defaultParams, routeParams)
      }

  return $.extend({}, defaultParams, routeParams, params);
}

function setupFilters(defaultParams, routeParams) {
  var defaultFilters = parseFilters(defaultParams),
      routeFilters = parseRouteFilters(routeParams);

  return $.extend({}, defaultFilters, routeFilters);
}

function parseFilters(params) {
  var filters = {};

  $.each(params.filter_values, function (i, value) {
    var field = params.filter_fields[i];
    if (value === "") {
      return;
    }
    filters[field] = filters[field] || [];
    filters[field].push(value);
  });

  return filters;
}

function parseRouteFilters(routeParams) {
  // The filters are in format "field:value|field:value|field:value"
  var filters = {},
      fieldValuesStr = routeParams.filters.split("|");

  $.each(fieldValuesStr, function (i, fieldValueStr) {
    var fieldValue = fieldValueStr.split(":"),
        field = fieldValue[0],
        value = fieldValue[1];

    filters[field] = filters[field] || [];
    filters[field].push(value);
  });

  return filters;
}
</script>
{% endblock %}

<div style="height: 500px;" id="graph"></div>
